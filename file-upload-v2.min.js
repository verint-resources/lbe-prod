var uploadAreaClass="custom_fileupload_area",sharepointParams={file:void 0,files:[],inputFileID:'$("#custom_fileupload_holder")',randomNumber:"",allowedFileType:"",maxFileSize:"50000000",maxFileSizeDisplay:"50000000",imgClickSelector:"",deleteFileSelector:"",kdfSaveFlag:!1,full_classification:"",fileUploadUrl:"https://graph.microsoft.com/v1.0/sites/enfield365.sharepoint.com,8aefec91-2c1c-46fd-b8b3-5432b919e464,02b1cf68-eb76-454d-b501-e1642db1f5d9/drive/items/",fieldNames:[]};function setFiledNames(e){sharepointParams.fieldNames=e}function do_KDF_Ready_SharepointV2(e,a){window.location.href.indexOf("https://lbe.")>-1&&(sharepointParams.fileUploadUrl="https://graph.microsoft.com/v1.0/sites/enfield365.sharepoint.com,0abdd322-1a3a-4fa5-8a3c-9e021152aab7,c82bbb33-b259-4604-9365-42c364d6172b/drive/items/");var t=KDF.getVal("txt_FT_template");(""==KDF.getVal("txt_FT_template")||$("#dform_widget_txt_FT_template").length<1)&&(t="FT_template1"),KDF.customdata("sharepoint_config","",!0,!0,{ft_operation:"file_list",txt_FT_template:t}),KDF.kdf().form.readonly&&"citizen"==KDF.kdf().access||"R"==KDF.kdf().viewmode?(KDF.makeReadonly(),KDF.hideWidget("ahtm_custom_fileupload"),KDF.showSection("area_file_view_mode"),KDF.customdata("sharepoint_token","imitateKdfReady readonly",!0,!0,{})):"U"==KDF.kdf().viewmode&&(KDF.showWidget("ahtm_custom_fileupload"),KDF.hideSection("area_file_view_mode"),KDF.customdata("sharepoint_token","imitateKdfReady readonly",!0,!0,{})),$("#custom_fileupload_holder"),$(document).on("drop dragover",function(e){e.preventDefault()}),$(document).on("change","#custom_fileupload",function(){var e=$("#custom_fileupload")[0].files[0].name.split(".").pop(),a=KDF.getVal("txt_FT_template");(""==KDF.getVal("txt_FT_template")||$("#dform_widget_txt_FT_template").length<1)&&(a="FT_template1"),KDF.customdata("sharepoint_config","",!0,!0,{txt_FT_template:a,txt_file_format:e})}),$("body").on("click","img",function(){$(this).data("fieldname")&&KDF.kdf().form.readonly&&(sharepointParams.imgClickSelector=$(this).data("fieldname"),KDF.customdata("sharepoint_token","imgClickEvent",!0,!0,{}))}),$("body").on("click",".fileicon",function(){$(this).data("fieldname")&&KDF.kdf().form.readonly&&(sharepointParams.imgClickSelector=$(this).data("fieldname"),KDF.customdata("sharepoint_token","imgClickEvent",!0,!0,{}))}),$("body").on("click",".delete_file",function(){sharepointParams.deleteFileSelector=$(this).closest("span").data("fieldname"),KDF.customdata("sharepoint_token","imgClickEvent",!0,!0,{})}),$("html").on("dragover",function(e){e.preventDefault(),e.stopPropagation(),$(".area-description").text("Drag here")}),$("html").on("drop",function(e){e.preventDefault(),e.stopPropagation()}),$("."+uploadAreaClass).on("dragenter",function(e){e.stopPropagation(),e.preventDefault(),$(".area-description").text("Drop")}),$("."+uploadAreaClass).on("dragover",function(e){e.stopPropagation(),e.preventDefault(),$(".area-description").text("Drop")}),$("."+uploadAreaClass).on("click",function(e){$("#custom_fileupload").click()}),$(".custom_fileupload_area").on("drop",function(e){e.stopPropagation(),e.preventDefault(),$(".custom_fileupload_area h1").text("Upload"),sharepointParams.files=e.originalEvent.dataTransfer.files;var a=e.originalEvent.dataTransfer.files[0].name,t=a.split(".").pop(),i=KDF.getVal("txt_FT_template");(""==KDF.getVal("txt_FT_template")||$("#dform_widget_txt_FT_template").length<1)&&(i="FT_template1"),KDF.customdata("sharepoint_config","custom_fileupload_area",!0,!0,{txt_FT_template:i,txt_file_format:t,file_name:a})}),$("#uploadfile").click(function(){$("#file").click()}),$("#file").change(function(){var e=new FormData,a=$("#file")[0].files[0];e.append("file",a),uploadData(e)})}function setFileV2(e){sharepointParams.file=e}function processDroppedFile(e){var a=!1,t=e.data.file_name,i=Array.from(sharepointParams.files).find(function(e){if(e.name===t)return e});if(i.size<=sharepointParams.maxFileSize?a=!1:(a=!0,KDF.showError("File size is too large")),!a&&(fileNames=[],sharepointParams.fieldNames.every(function(e){return""!==KDF.getVal("txt_filename_"+e)})&&(a=!0,KDF.showError("Maximum number of file uploads has been reached"))),!a){for(var o=0;o<sharepointParams.fieldNames.length;o++)if(KDF.getVal("txt_filename_"+sharepointParams.fieldNames[o])==t){a=!0,KDF.showError("A file with this name already exists");break}}if(!a){KDF.hideMessages(),setProgressV2(0),setProgressV2(10),$("#custom_fileupload").prop("disabled",!0);var s=new FileReader;s.readAsArrayBuffer(i),s.onloadend=function(){setFileV2(i),setProgressV2(25),sharepointParams.kdfSaveFlag?KDF.customdata("sharepoint_token","imitateKdfReady",!0,!0,{}):(KDF.save(),document.getElementById("custom_fileupload_holder").focus())}}}function processFileV2(){var e=!1,a=$("#custom_fileupload")[0].files[0].name;if(a.split(".").pop(),$("#custom_fileupload")[0].files[0].size<=sharepointParams.maxFileSize?e=!1:(e=!0,KDF.showError("File size is too large")),!e&&(fileNames=[],sharepointParams.fieldNames.every(function(e){return""!==KDF.getVal("txt_filename_"+e)})&&(e=!0,KDF.showError("Maximum number of file uploads has been reached"))),!e){for(var t=0;t<sharepointParams.fieldNames.length;t++)if(KDF.getVal("txt_filename_"+sharepointParams.fieldNames[t])==a){e=!0,KDF.showError("A file with this name already exists");break}}if(!e){KDF.hideMessages(),setProgressV2(0),setProgressV2(10),$("#custom_fileupload").prop("disabled",!0);var i=new FileReader;i.readAsArrayBuffer($("#custom_fileupload")[0].files[0]),i.onloadend=function(){setFileV2($("#custom_fileupload")[0].files[0]),setProgressV2(25),sharepointParams.kdfSaveFlag?KDF.customdata("sharepoint_token","imitateKdfReady",!0,!0,{}):(KDF.save(),document.getElementById("custom_fileupload_holder").focus())}}}function setFileThumbnailsV2(e){sharepointParams.fieldNames.forEach(function(a){""!==KDF.getVal("txt_filename_"+a)&&sharepointFileThumbnailV2(KDF.getVal("txt_sharepointID_"+a),e,"txt_filename_"+a,a)})}function do_KDF_Custom_Sharepoint(e,a){do_KDF_Custom_SharepointV2(e,a)}function do_KDF_Custom_SharepointV2(e,a){if("sharepoint_token"===a){var t=e.data.access_token;KDF.kdf().form.readonly||""!=sharepointParams.deleteFileSelector?KDF.kdf().form.readonly||""===sharepointParams.deleteFileSelector||deleteFileV2(t):"U"!=KDF.kdf().viewmode||sharepointParams.file?sharepointParams.file&&(sharepointParams.kdfSaveFlag||(sharepointParams.kdfSaveFlag=!0,sharepointParams.full_classification=e.data.full_classification),sharepointFileUploaderV2(t)):setFileThumbnailsV2(t),KDF.kdf().form.readonly&&""==sharepointParams.imgClickSelector?setFileThumbnailsV2(t):KDF.kdf().form.readonly&&""!==sharepointParams.imgClickSelector&&sharepointDownloadFileV2(t)}else if("sharepoint_config"==a){if(e.data.pass_status)"good"===e.data.pass_status?e.actionedby===uploadAreaClass?processDroppedFile(e):processFileV2():KDF.showError("Incorrect file type selected.");else{var i="";i=$("#dform_widget_txt_sharepoint_title").length>0?KDF.getVal("txt_sharepoint_title"):"Please upload files";var o=e.data.txt_file_types;if(sharepointParams.allowedFileType=o.replace(/'/g,"").replace("(","").replace(")","").replace(/,/g,", "),sharepointParams.maxFileSizeDisplay=e.data.txt_max_filesize,$("#custom_fileupload_holder").length>0){var s='<div data-type="file" data-name="file_ootb" data-active="true" data-agentonly="false" class="file-progress lbe-file-gov"><div><label>'+i+'</div></label><div style="position: relative;"><input id="custom_fileupload" type="file" name="uploadedFile" aria-label="Upload file"><span class="file-gov-icon"><span class="file-gov-icon-a"></span><span class="file-gov-icon-b"></span><label class="file-gov-text">Upload file</label></span><div class="helptext">Accepted file types are '+sharepointParams.allowedFileType+" up to "+sharepointParams.maxFileSizeDisplay+' MB in size</div><div class="dform_fileupload_progressbar" id="custom_fileupload_progressbar"></div><div class="filenames" id="custom_fileupload_files"></div><br><br></div> </div>';$("#custom_fileupload_holder").html(s)}$("."+uploadAreaClass).length>0&&($(".sharepoint_title").text(i),$(".allowedFileType").text(sharepointParams.allowedFileType),$(".maxFileSizeDisplay").text(sharepointParams.maxFileSizeDisplay))}}}function do_KDF_Save_SharepointV2(){sharepointParams.file||$("#custom_fileupload").focus(),!sharepointParams.kdfSaveFlag&&sharepointParams.file&&($("#custom_fileupload").focus(),$("#dform_successMessage").remove(),KDF.customdata("sharepoint_token","imitateKdfReady",!0,!0,{SaveForm:"true",caseid:KDF.kdf().form.caseid}))}function sharepointFileUploaderV2(e){KDF.lock(),getUploadSessionV2(e)}function sharepointFileThumbnailV2(e,a,t,i){var o=sharepointParams.fileUploadUrl+e+"/thumbnails";$.ajax({url:o,dataType:"json",headers:{Authorization:a},method:"GET"}).done(function(e){var a=e.value[0]?e.value[0].medium.url:void 0;if(KDF.kdf().form.readonly){if(KDF.kdf().form.readonly||"R"==KDF.kdf().viewmode){var o,s=KDF.getVal(t);o='<div id="'+t+'"style="float: left;"><div style="margin-right: 10px">'+getImage(a,t,s,i)+"</div><div>"+s+"</div></div>",setTimeout(function(){$("#custom_fileupload_view").append(o)},1e3)}}else if("U"!==KDF.kdf().viewmode||sharepointParams.file){if(sharepointParams.file){for(var l=0;l<sharepointParams.fieldNames.length;l++){var r=sharepointParams.fieldNames[l];if(""==KDF.getVal("txt_filename_"+r+"_thumb")){KDF.setVal("txt_filename_"+r+"_thumb",a);break}}setProgressV2(60),setTimeout(function(){addFileContainerV2(),setProgressV2(0)},1e3)}}else i&&KDF.setVal("txt_filename_"+i+"_thumb",a),addFileContainerV2(i)}),$("#custom_fileupload").prop("disabled",!1)}function addFileContainerV2(e){$("input#custom_fileupload").val("");var a,t,i="txt_filename_"+e;if("U"!=KDF.kdf().viewmode||sharepointParams.file){if(sharepointParams.file){for(var o=0;o<sharepointParams.fieldNames.length;o++)if($(".filenames .txt_filename_"+(e=sharepointParams.fieldNames[o])).length<1){a=KDF.getVal("txt_filename_"+e),t=KDF.getVal("txt_filename_"+e+"_thumb"),i="txt_filename_"+e;break}}}else a=KDF.getVal(i),t=KDF.getVal(i+"_thumb");$(".filenames").append('<span class="'+i+'"> <span class="img_container"> '+getImage(t,i,a,e)+"<div>"+a+'<span id="delete_'+i+'" data-fieldname="'+e+'" style="font-weight:bold;" class="delete_file">4</span></div></span></span>'),KDF.unlock()}function getImage(e,a,t,i){return e?' <img id="img_'+a+'" data-filename="'+t+'"data-fieldname="'+i+'" src='+e+'" > ':' <span class="fileicon" data-filename="'+t+'" data-fieldname="'+i+'">e</span> '}function sharepointDownloadFileV2(e){var a=KDF.getVal("txt_sharepointID_"+sharepointParams.imgClickSelector),t=sharepointParams.fileUploadUrl+a+"/preview";$.ajax({url:t,headers:{Authorization:e},type:"POST"}).done(function(e){window.open(e.getUrl)}).fail(function(){}),sharepointParams.imgClickSelector=""}function deleteFileV2(e){setProgressV2(0);var a=sharepointParams.deleteFileSelector,t=KDF.getVal("txt_sharepointID_"+a),i=sharepointParams.fileUploadUrl+t;$.ajax({url:i,processData:!1,headers:{Authorization:e},method:"DELETE"}).done(function(e){$("span.txt_filename_"+a).remove(),KDF.setVal("txt_sharepointID_"+a,""),KDF.setVal("txt_filename_"+a,""),KDF.setVal("txt_filename_"+a+"_thumb",""),KDF.save()}).fail(function(){KDF.showError("Delete file has failed, please try again")}),sharepointParams.deleteFileSelector=""}function getUploadSessionV2(e){var a=sharepointParams.file.name,t=sharepointParams.fileUploadUrl+"root:/Verint/"+sharepointParams.full_classification+"/"+KDF.kdf().form.caseid+"/"+a;"MEQ"===KDF.getVal("txt_case_subject")&&""!==KDF.kdf().viewmode&&"citizen"!==KDF.kdf().access&&(t=sharepointParams.fileUploadUrl+"root:/Verint/"+KDF.getVal("txt_lead_classification")+"/"+KDF.getVal("txt_lead_id")+"/"+a),$.ajax({type:"POST",url:t+":/createUploadSession",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:e},body:{item:{"@odata.type":"microsoft.graph.driveItemUploadableProperties","@microsoft.graph.conflictBehavior":"rename",name:a}}}).done(function(a){setProgressV2(30);var t=a.uploadUrl;uploadChunksV2(sharepointParams.file,t,e)}).fail(function(e){})}async function uploadChunksV2(e,a,t){new FileReader;for(var i,o=0,s=!0;s;)try{s=!0;try{if((i=await readFragmentAsyncV2(e,o,o+4e6)).byteLength>0)s=!0;else break}catch(l){break}try{let r=await uploadChunkV2(i,a,o,e.size);if(202!==r.status&&201!==r.status&&200!==r.status)throw"Put operation did not return expected response";if(201===r.status||200===r.status){s=!1,sharepointFileThumbnailV2(r.json.id,t),setProgressV2(60);for(var n=0;n<sharepointParams.fieldNames.length;n++){var d=sharepointParams.fieldNames[n];if(""==KDF.getVal("txt_sharepointID_"+d)){KDF.setVal("txt_sharepointID_"+d,r.json.id),KDF.setVal("txt_filename_"+d,r.json.name),KDF.setVal("txt_sharepoint_link_"+d,r.json.webUrl);break}}KDF.save()}else{var f=Math.round(30+Number(30/e.size*o));setProgressV2(f),o=Number(r.json.nextExpectedRanges[0].split("-")[0])}}catch(p){}}catch(m){s=!1}}function setProgressV2(e){$(".dform_fileupload_progressbar").html("<div style='width: "+e+"%;'>")}function readFragmentAsyncV2(e,a,t){var i="";let o=new FileReader;var s=e.slice(a,t);return o.readAsArrayBuffer(s),new Promise((e,a)=>{o.onloadend=a=>{o.readyState===o.DONE&&e(i=o.result)}})}function uploadChunkV2(e,a,t,i){var o=t+e.byteLength-1;return new Promise((s,l)=>{try{$.ajax({type:"PUT",contentType:"application/octet-stream",url:a,data:e,processData:!1,headers:{"Content-Range":"bytes "+t+"-"+o+"/"+i}}).done(function(e,a,t){t.responseJSON.nextExpectedRanges,(results={}).status=t.status,results.json=t.responseJSON,s(results)}).fail(function(e){})}catch(r){l(r)}})}
