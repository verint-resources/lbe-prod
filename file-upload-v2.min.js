var uploadAreaClass="custom_fileupload_area",formParams={file:void 0,files:[],inputFileID:'$("#custom_fileupload_holder")',randomNumber:"",allowedFileType:"",maxFileSize:"20000000",maxFileSizeDisplay:"20000000",imgClickSelector:"",deleteFileSelector:"",kdfSaveFlag:!1,full_classification:"",fileUploadUrl:"https://graph.microsoft.com/v1.0/sites/enfield365.sharepoint.com,8aefec91-2c1c-46fd-b8b3-5432b919e464,02b1cf68-eb76-454d-b501-e1642db1f5d9/drive/items/",fieldNames:[]};function setFiledNames(fieldnames){formParams.fieldNames=fieldnames}function do_KDF_Ready_SharepointV2(event,kdf){var hostURL;window.location.href.indexOf("https://lbe.")>-1&&(formParams.fileUploadUrl="https://graph.microsoft.com/v1.0/sites/enfield365.sharepoint.com,0abdd322-1a3a-4fa5-8a3c-9e021152aab7,c82bbb33-b259-4604-9365-42c364d6172b/drive/items/");var template_name=KDF.getVal("txt_FT_template");(""==KDF.getVal("txt_FT_template")||$("#dform_widget_txt_FT_template").length<1)&&(template_name="FT_template1"),KDF.customdata("sharepoint_config","",!0,!0,{ft_operation:"file_list",txt_FT_template:template_name}),KDF.kdf().form.readonly&&"citizen"==KDF.kdf().access||"R"==KDF.kdf().viewmode?(KDF.makeReadonly(),KDF.hideWidget("ahtm_custom_fileupload"),KDF.showSection("area_file_view_mode"),KDF.customdata("sharepoint_token","imitateKdfReady readonly",!0,!0,{})):"U"==KDF.kdf().viewmode&&(KDF.showWidget("ahtm_custom_fileupload"),KDF.hideSection("area_file_view_mode"),KDF.customdata("sharepoint_token","imitateKdfReady readonly",!0,!0,{}));var CustomFileUploadWidget=$("#custom_fileupload_holder");$(document).on("drop dragover",(function(e){e.preventDefault()})),$(document).on("change","#custom_fileupload",(function(){var fileName,fileExtension=$("#custom_fileupload")[0].files[0].name.split(".").pop(),template_name=KDF.getVal("txt_FT_template");(""==KDF.getVal("txt_FT_template")||$("#dform_widget_txt_FT_template").length<1)&&(template_name="FT_template1"),KDF.customdata("sharepoint_config","",!0,!0,{txt_FT_template:template_name,txt_file_format:fileExtension})})),$("body").on("click","img",(function(){$(this).data("fieldname")&&KDF.kdf().form.readonly&&(formParams.imgClickSelector=$(this).data("fieldname"),KDF.customdata("sharepoint_token","imgClickEvent",!0,!0,{}))})),$("body").on("click",".fileicon",(function(){$(this).data("fieldname")&&KDF.kdf().form.readonly&&(formParams.imgClickSelector=$(this).data("fieldname"),KDF.customdata("sharepoint_token","imgClickEvent",!0,!0,{}))})),$("body").on("click",".delete_file",(function(){formParams.deleteFileSelector=$(this).closest("span").data("fieldname"),KDF.customdata("sharepoint_token","imgClickEvent",!0,!0,{})})),$("html").on("dragover",(function(e){e.preventDefault(),e.stopPropagation(),$(".area-description").text("Drag here")})),$("html").on("drop",(function(e){e.preventDefault(),e.stopPropagation()})),$("."+uploadAreaClass).on("dragenter",(function(e){e.stopPropagation(),e.preventDefault(),$(".area-description").text("Drop")})),$("."+uploadAreaClass).on("dragover",(function(e){e.stopPropagation(),e.preventDefault(),$(".area-description").text("Drop")})),$("."+uploadAreaClass).on("click",(function(e){$("#custom_fileupload").click()})),$(".custom_fileupload_area").on("drop",(function(e){e.stopPropagation(),e.preventDefault(),$(".custom_fileupload_area h1").text("Upload"),formParams.files=e.originalEvent.dataTransfer.files;var file,fileName=e.originalEvent.dataTransfer.files[0].name,fileExtension=fileName.split(".").pop(),template_name=KDF.getVal("txt_FT_template");(""==KDF.getVal("txt_FT_template")||$("#dform_widget_txt_FT_template").length<1)&&(template_name="FT_template1"),KDF.customdata("sharepoint_config","custom_fileupload_area",!0,!0,{txt_FT_template:template_name,txt_file_format:fileExtension,file_name:fileName})})),$("#uploadfile").click((function(){$("#file").click()})),$("#file").change((function(){var fd=new FormData,files=$("#file")[0].files[0];fd.append("file",files),uploadData(fd)}))}function setFileV2(file){formParams.file=file}function processDroppedFile(response){var fileError=!1,fileName=response.data.file_name,file=Array.from(formParams.files).find((function(file){if(file.name===fileName)return file}));if(file.size<=formParams.maxFileSize?fileError=!1:(fileError=!0,KDF.showError("File size is too large")),fileError||(fileNames=[],formParams.fieldNames.every((function(fieldName){return""!==KDF.getVal("txt_filename_"+fieldName)}))&&(fileError=!0,KDF.showError("Maximum number of file uploads has been reached"))),!fileError)for(var i=0;i<formParams.fieldNames.length;i++)if(KDF.getVal("txt_filename_"+formParams.fieldNames[i])==fileName){fileError=!0,KDF.showError("A file with this name already exists");break}if(!fileError){KDF.hideMessages(),setProgressV2(0),setProgressV2(10),$("#custom_fileupload").prop("disabled",!0);var reader=new FileReader;reader.readAsArrayBuffer(file),reader.onloadend=function(){setFileV2(file),setProgressV2(25),formParams.kdfSaveFlag?KDF.customdata("sharepoint_token","imitateKdfReady",!0,!0,{}):(KDF.save(),document.getElementById("custom_fileupload_holder").focus())}}}function processFileV2(){var fileError=!1,fileName=$("#custom_fileupload")[0].files[0].name,fileNameClean=fileName.split(".").pop();if($("#custom_fileupload")[0].files[0].size<=formParams.maxFileSize?fileError=!1:(fileError=!0,KDF.showError("File size is too large")),fileError||(fileNames=[],formParams.fieldNames.every((function(fieldName){return""!==KDF.getVal("txt_filename_"+fieldName)}))&&(fileError=!0,KDF.showError("Maximum number of file uploads has been reached"))),!fileError)for(var i=0;i<formParams.fieldNames.length;i++)if(KDF.getVal("txt_filename_"+formParams.fieldNames[i])==fileName){fileError=!0,KDF.showError("A file with this name already exists");break}if(!fileError){KDF.hideMessages(),setProgressV2(0),setProgressV2(10),$("#custom_fileupload").prop("disabled",!0);var reader=new FileReader;reader.readAsArrayBuffer($("#custom_fileupload")[0].files[0]),reader.onloadend=function(){setFileV2($("#custom_fileupload")[0].files[0]),setProgressV2(25),formParams.kdfSaveFlag?KDF.customdata("sharepoint_token","imitateKdfReady",!0,!0,{}):(KDF.save(),document.getElementById("custom_fileupload_holder").focus())}}}function setFileThumbnailsV2(access_token){formParams.fieldNames.forEach((function(name){""!==KDF.getVal("txt_filename_"+name)&&sharepointFileThumbnailV2(KDF.getVal("txt_sharepointID_"+name),access_token,"txt_filename_"+name,name)}))}function do_KDF_Custom_SharepointV2(response,action){if("sharepoint_token"===action){var access_token=response.data.access_token;KDF.kdf().form.readonly||""!=formParams.deleteFileSelector?KDF.kdf().form.readonly||""===formParams.deleteFileSelector||deleteFileV2(access_token):"U"!=KDF.kdf().viewmode||formParams.file?formParams.file&&(formParams.kdfSaveFlag||(formParams.kdfSaveFlag=!0,formParams.full_classification=response.data.full_classification),sharepointFileUploaderV2(access_token)):setFileThumbnailsV2(access_token),KDF.kdf().form.readonly&&""==formParams.imgClickSelector?setFileThumbnailsV2(access_token):KDF.kdf().form.readonly&&""!==formParams.imgClickSelector&&sharepointDownloadFileV2(access_token)}else if("sharepoint_config"==action)if(response.data.pass_status)"good"===response.data.pass_status?response.actionedby===uploadAreaClass?processDroppedFile(response):processFileV2():KDF.showError("Incorrect file type selected.");else{var sharepoint_title="";sharepoint_title=$("#dform_widget_txt_sharepoint_title").length>0?KDF.getVal("txt_sharepoint_title"):"Please upload files";var txt_file_types=response.data.txt_file_types;if(formParams.allowedFileType=txt_file_types.replace(/'/g,"").replace("(","").replace(")","").replace(/,/g,", "),formParams.maxFileSizeDisplay=response.data.txt_max_filesize,$("#custom_fileupload_holder").length>0){var widget='<div data-type="file" data-name="file_ootb" data-active="true" data-agentonly="false" class="file-progress lbe-file-gov"><div><label>'+sharepoint_title+'</div></label><div style="position: relative;"><input id="custom_fileupload" type="file" name="uploadedFile" aria-label="Upload file"><span class="file-gov-icon"><span class="file-gov-icon-a"></span><span class="file-gov-icon-b"></span><label class="file-gov-text">Upload file</label></span><div class="helptext">Accepted file types are '+formParams.allowedFileType+" up to "+formParams.maxFileSizeDisplay+' MB in size</div><div class="dform_fileupload_progressbar" id="custom_fileupload_progressbar"></div><div class="filenames" id="custom_fileupload_files"></div><br><br></div> </div>';$("#custom_fileupload_holder").html(widget)}$("."+uploadAreaClass).length>0&&($(".sharepoint_title").text(sharepoint_title),$(".allowedFileType").text(formParams.allowedFileType),$(".maxFileSizeDisplay").text(formParams.maxFileSizeDisplay))}}function do_KDF_Save_SharepointV2(){formParams.file||$("#custom_fileupload").focus(),formParams.kdfSaveFlag||formParams.file&&($("#custom_fileupload").focus(),$("#dform_successMessage").remove(),KDF.customdata("sharepoint_token","imitateKdfReady",!0,!0,{SaveForm:"true",caseid:KDF.kdf().form.caseid}))}function sharepointFileUploaderV2(access_token){KDF.lock(),getUploadSessionV2(access_token)}function sharepointFileThumbnailV2(itemID,access_token,widgetName,fieldName){var getThumbnailURL=formParams.fileUploadUrl+itemID+"/thumbnails";$.ajax({url:getThumbnailURL,dataType:"json",headers:{Authorization:access_token},method:"GET"}).done((function(response){var thumbnailURL=response.value[0]?response.value[0].medium.url:void 0;if(KDF.kdf().form.readonly){if(KDF.kdf().form.readonly||"R"==KDF.kdf().viewmode){var fileName=KDF.getVal(widgetName),html;html='<div id="'+widgetName+'"style="float: left;"><div style="margin-right: 10px">'+getImage(thumbnailURL,widgetName,fileName,fieldName)+"</div><div>"+fileName+"</div></div>",setTimeout((function(){$("#custom_fileupload_view").append(html)}),1e3)}}else if("U"!==KDF.kdf().viewmode||formParams.file){if(formParams.file){for(var i=0;i<formParams.fieldNames.length;i++){var name=formParams.fieldNames[i];if(""==KDF.getVal("txt_filename_"+name+"_thumb")){KDF.setVal("txt_filename_"+name+"_thumb",thumbnailURL);break}}setProgressV2(60),setTimeout((function(){addFileContainerV2(),setProgressV2(0)}),1e3)}}else fieldName&&KDF.setVal("txt_filename_"+fieldName+"_thumb",thumbnailURL),addFileContainerV2(fieldName)})),$("#custom_fileupload").prop("disabled",!1)}function addFileContainerV2(fieldName){var fileName,fileThumbnail;$("input#custom_fileupload").val("");var widgetName="txt_filename_"+fieldName;if("U"!=KDF.kdf().viewmode||formParams.file){if(formParams.file)for(var i=0;i<formParams.fieldNames.length;i++)if(fieldName=formParams.fieldNames[i],$(".filenames .txt_filename_"+fieldName).length<1){fileName=KDF.getVal("txt_filename_"+fieldName),fileThumbnail=KDF.getVal("txt_filename_"+fieldName+"_thumb"),widgetName="txt_filename_"+fieldName;break}}else fileName=KDF.getVal(widgetName),fileThumbnail=KDF.getVal(widgetName+"_thumb");$(".filenames").append('<span class="'+widgetName+'"> <span class="img_container"> '+getImage(fileThumbnail,widgetName,fileName,fieldName)+"<div>"+fileName+'<span id="delete_'+widgetName+'" data-fieldname="'+fieldName+'" style="font-weight:bold;" class="delete_file">4</span></div></span></span>'),KDF.unlock()}function getImage(fileThumbnail,widgetName,fileName,fieldName){return fileThumbnail?' <img id="img_'+widgetName+'" data-filename="'+fileName+'"data-fieldname="'+fieldName+'" src='+fileThumbnail+'" > ':' <span class="fileicon" data-filename="'+fileName+'" data-fieldname="'+fieldName+'">e</span> '}function sharepointDownloadFileV2(access_token){var sharepointID=KDF.getVal("txt_sharepointID_"+formParams.imgClickSelector),getFileURL=formParams.fileUploadUrl+sharepointID+"/preview";$.ajax({url:getFileURL,headers:{Authorization:access_token},type:"POST"}).done((function(response){window.open(response.getUrl)})).fail((function(){})),formParams.imgClickSelector=""}function deleteFileV2(access_token){setProgressV2(0);var selector=formParams.deleteFileSelector,fileID=KDF.getVal("txt_sharepointID_"+selector),deleteURL=formParams.fileUploadUrl+fileID;$.ajax({url:deleteURL,processData:!1,headers:{Authorization:access_token},method:"DELETE"}).done((function(response){$("span.txt_filename_"+selector).remove(),KDF.setVal("txt_sharepointID_"+selector,""),KDF.setVal("txt_filename_"+selector,""),KDF.setVal("txt_filename_"+selector+"_thumb",""),KDF.save()})).fail((function(){KDF.showError("Delete file has failed, please try again")})),formParams.deleteFileSelector=""}function getUploadSessionV2(access_token){var fileName=formParams.file.name,url=formParams.fileUploadUrl+"root:/Verint/"+formParams.full_classification+"/"+KDF.kdf().form.caseid+"/"+fileName;"MEQ"===KDF.getVal("txt_case_subject")&&""!==KDF.kdf().viewmode&&"citizen"!==KDF.kdf().access&&(url=formParams.fileUploadUrl+"root:/Verint/"+KDF.getVal("txt_lead_classification")+"/"+KDF.getVal("txt_lead_id")+"/"+fileName);const body={item:{"@odata.type":"microsoft.graph.driveItemUploadableProperties","@microsoft.graph.conflictBehavior":"rename",name:fileName}};$.ajax({type:"POST",url:url+":/createUploadSession",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:access_token},body:body}).done((function(response){setProgressV2(30);var uploadUrl=response.uploadUrl;uploadChunksV2(formParams.file,uploadUrl,access_token)})).fail((function(response){}))}async function uploadChunksV2(file,uploadUrl,access_token){for(var reader=new FileReader,position=0,chunkLength=4e6,continueRead=!0;continueRead;){var chunk;try{continueRead=!0;try{let stopByte=position+4e6;if(!((chunk=await readFragmentAsyncV2(file,position,stopByte)).byteLength>0))break;continueRead=!0}catch(e){break}try{let res=await uploadChunkV2(chunk,uploadUrl,position,file.size);if(202!==res.status&&201!==res.status&&200!==res.status)throw"Put operation did not return expected response";if(201===res.status||200===res.status){continueRead=!1,sharepointFileThumbnailV2(res.json.id,access_token),setProgressV2(60);for(var i=0;i<formParams.fieldNames.length;i++){var name=formParams.fieldNames[i];if(""==KDF.getVal("txt_sharepointID_"+name)){KDF.setVal("txt_sharepointID_"+name,res.json.id),KDF.setVal("txt_filename_"+name,res.json.name),KDF.setVal("txt_sharepoint_link_"+name,res.json.webUrl);break}}KDF.save()}else{var progress;setProgressV2(Math.round(30+Number(30/file.size*position))),position=Number(res.json.nextExpectedRanges[0].split("-")[0])}}catch(e){}}catch(e){continueRead=!1}}}function setProgressV2(progress){$(".dform_fileupload_progressbar").html("<div style='width: "+progress+"%;'>")}function readFragmentAsyncV2(file,startByte,stopByte){var frag="";const reader=new FileReader;var blob=file.slice(startByte,stopByte);return reader.readAsArrayBuffer(blob),new Promise((resolve,reject)=>{reader.onloadend=event=>{reader.readyState===reader.DONE&&(frag=reader.result,resolve(frag))}})}function uploadChunkV2(chunk,uploadURL,position,totalLength){var max=position+chunk.byteLength-1;return new Promise((resolve,reject)=>{try{let crHeader="bytes "+position+"-"+max+"/"+totalLength;$.ajax({type:"PUT",contentType:"application/octet-stream",url:uploadURL,data:chunk,processData:!1,headers:{"Content-Range":crHeader}}).done((function(data,textStatus,jqXHR){jqXHR.responseJSON.nextExpectedRanges,results={},results.status=jqXHR.status,results.json=jqXHR.responseJSON,resolve(results)})).fail((function(response){}))}catch(e){reject(e)}})}